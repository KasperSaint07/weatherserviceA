<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Weather ‚Äî Live WS</title>
    <style>
        :root{--card:#f6f7fb;--border:#e6e8ef}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:32px auto;padding:0 16px}
        h1{font-size:28px;margin:0 0 8px}
        #status{font-size:14px;color:#666;margin-bottom:16px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
        .row{display:flex;gap:12px;align-items:baseline}
        .k{color:#666;min-width:110px}
        .v{font-weight:700}
        .toolbar{display:flex;gap:8px;flex-wrap:wrap}
        button{border:1px solid var(--border);background:white;border-radius:10px;padding:8px 12px;cursor:pointer}
        button.active{background:#111;color:#fff;border-color:#111}
        form.manual{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        input[type=number]{width:110px;padding:8px;border:1px solid var(--border);border-radius:10px}
        pre{margin:0;white-space:pre-wrap}
        .muted{color:#666;font-size:13px}
    </style>
</head>
<body>
<h1>üå§Ô∏è Weather ‚Äî WebSocket stream</h1>
<div id="status">Connecting‚Ä¶</div>

<div class="grid">
    <!-- –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è -->
    <div class="card">
        <div class="row"><span class="k">Temperature:</span> <span id="t" class="v">‚Äî</span></div>
        <div class="row"><span class="k">Humidity:</span>    <span id="h" class="v">‚Äî</span></div>
        <div class="row"><span class="k">Pressure:</span>    <span id="p" class="v">‚Äî</span></div>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–π -->
    <div class="card">
        <div class="row"><span class="k">Strategy:</span>
            <div class="toolbar">
                <button data-str="realtime" id="btn-rt">Realtime</button>
                <button data-str="batch"    id="btn-batch">Batch</button>
                <button data-str="manual"   id="btn-man">Manual</button>
            </div>
        </div>
        <div class="muted" style="margin-top:8px">
            Realtime ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ; Batch ‚Äî ¬´–ø–ª–∞–≤–Ω–∞—è¬ª –º–æ–¥–µ–ª—å; Manual ‚Äî –±–µ—Ä—ë—Ç –∏–∑ —Ñ–æ—Ä–º—ã –Ω–∏–∂–µ.
        </div>
    </div>

    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
    <div class="card">
        <form id="manualForm" class="manual" onsubmit="return false;">
            <strong>Manual input:</strong>
            <label>T (¬∞C) <input id="in-t" type="number" step="0.1" required></label>
            <label>H (%)  <input id="in-h" type="number" step="0.1" required></label>
            <label>P (hPa)<input id="in-p" type="number" step="0.1" required></label>
            <button id="btn-apply">Apply</button>
        </form>
        <div class="muted">–ù–∞–∂–º–∏ Apply ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ <em>manual</em>, –∏ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º —É–π–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.</div>
    </div>

    <!-- –°—ã—Ä–æ–π JSON -->
    <div class="card"><pre id="raw">{}</pre></div>
</div>

<script>
    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const t = document.getElementById('t');
    const h = document.getElementById('h');
    const p = document.getElementById('p');
    const raw = document.getElementById('raw');
    const statusEl = document.getElementById('status');
    const buttons = [...document.querySelectorAll('button[data-str]')];

    // WS URL
    const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/weather';

    // helpers
    function setActive(name){
        buttons.forEach(b=>b.classList.toggle('active', b.dataset.str===name));
    }
    async function callChangeStrategy(type){
        const r = await fetch(`/weather/strategy?type=${encodeURIComponent(type)}`, {method:'POST'});
        if(!r.ok) throw new Error('Strategy change failed');
        setActive(type);
    }
    async function callManual(t,h,pv){
        const qs = new URLSearchParams({t,h,p:pv}).toString();
        const r = await fetch(`/weather/manual?${qs}`, {method:'POST'});
        if(!r.ok) throw new Error('Manual update failed');
    }

    // –∫–Ω–æ–ø–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    buttons.forEach(b=>{
        b.addEventListener('click', async ()=>{
            try{
                await callChangeStrategy(b.dataset.str);
            }catch(e){ alert(e.message); }
        });
    });

    // —Ñ–æ—Ä–º–∞
    document.getElementById('btn-apply').addEventListener('click', async ()=>{
        const tv = document.getElementById('in-t').value;
        const hv = document.getElementById('in-h').value;
        const pv = document.getElementById('in-p').value;
        try{
            await callChangeStrategy('manual'); // –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
            await callManual(tv, hv, pv);       // –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è
        }catch(e){ alert(e.message); }
    });

    // WebSocket
    function connect(){
        const ws = new WebSocket(WS_URL);

        ws.onopen = ()=>{ statusEl.textContent = 'Connected ‚úì'; };
        ws.onmessage = e=>{
            try{
                const data = JSON.parse(e.data);
                t.textContent = data.temperature?.toFixed?.(1) ?? data.temperature;
                h.textContent = data.humidity?.toFixed?.(1) ?? data.humidity;
                p.textContent = data.pressure?.toFixed?.(1) ?? data.pressure;
                raw.textContent = JSON.stringify(data, null, 2);
            }catch{ raw.textContent = e.data; }
        };
        ws.onclose = ()=>{
            statusEl.textContent = 'Disconnected‚Ä¶ reconnecting in 2s';
            setTimeout(connect, 2000);
        };
        ws.onerror = ()=>{ statusEl.textContent = 'WS error'; };
    }
    connect();

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Å–≤–µ—Ç–∏–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–∞–∫ realtime
    setActive('realtime');
</script>
</body>
</html>
